<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Vagas por Turno</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
        .filters { display:flex; gap:12px; margin-bottom:20px; align-items:center; flex-wrap:wrap; }
        .filters select { padding:8px 12px; border:1px solid #ddd; border-radius:4px; font-size:0.9rem; }
        .filters button { padding:8px 16px; }
        
        .turno-section { margin-bottom:30px; padding:20px; background:#f9f9f9; border-radius:8px; border-left:4px solid #667eea; }
        .turno-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .turno-header h3 { margin:0; color:#333; }
        .turno-header .actions { display:flex; gap:8px; }
        
        .add-turno-form { margin-top:20px; padding:16px; background:#fff; border:1px solid #ddd; border-radius:8px; }
        .add-turno-form h4 { margin-top:0; color:#333; }
        .form-row { display:flex; gap:12px; margin-bottom:12px; align-items:flex-end; flex-wrap:wrap; }
        .form-row label { display:flex; flex-direction:column; gap:4px; }
        .form-row input, .form-row select { padding:8px 12px; border:1px solid #ddd; border-radius:4px; font-size:0.9rem; }
        .form-row input[type="number"] { width:120px; }
        .form-row select { min-width:150px; }
        
        .vacancies-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px; }
        .vacancy-card { padding:12px; background:#fff; border:1px solid #ddd; border-radius:6px; }
        .vacancy-card h4 { margin:0 0 8px 0; font-size:1rem; color:#333; }
        .vacancy-item { display:flex; justify-content:space-between; align-items:center; font-size:0.9rem; margin:4px 0; }
        .vacancy-item .label { color:#666; }
        .vacancy-item .value { font-weight:600; color:#667eea; }
        
        .turno-table { width:100%; border-collapse:collapse; margin-top:12px; }
        .turno-table th, .turno-table td { padding:10px 12px; border-bottom:1px solid #eee; text-align:left; font-size:0.9rem; }
        .turno-table th { background:#f5f5f5; font-weight:600; color:#333; }
        .turno-table tr:hover { background:#fafafa; }
        .turno-table .actions { display:flex; gap:6px; }
        .turno-table .actions button { padding:4px 8px; font-size:0.8rem; }
        
        .btn-sm { padding:4px 8px; font-size:0.8rem; }
        .btn-edit { background:#667eea; color:#fff; border:none; border-radius:4px; cursor:pointer; }
        .btn-edit:hover { background:#5a6fd8; }
        .btn-delete { background:#dc3545; color:#fff; border:none; border-radius:4px; cursor:pointer; }
        .btn-delete:hover { background:#c82333; }
        
        .empty-state { text-align:center; padding:40px 20px; color:#999; }
        .empty-state p { margin:0; font-size:0.95rem; }
        
        .alert { padding:12px 16px; border-radius:6px; margin-bottom:16px; }
        .alert-success { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
        .alert-error { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }
    </style>
</head>
<body>
<div class="container-app">
    <div class="hero">
        <div class="title">
            <h1>Gerenciar Vagas por Turno</h1>
            <div class="subtitle">Configure vagas específicas para cada turno de cada campus em cada edital</div>
        </div>
        <div class="toolbar">
            <a th:href="@{/}" class="btn btn-ghost">Home</a>
            <a th:href="@{/campus-edital/list}" class="btn btn-ghost">Voltar para Campus-Edital</a>
        </div>
    </div>

    <div class="card">
        <!-- Filtros -->
        <div class="filters">
            <div>
                <label style="display:flex; flex-direction:column; gap:4px; font-size:0.9rem;">
                    <span class="muted">Edital:</span>
                    <select id="filterEdital" name="editalId" onchange="filterByEdital()">
                        <option value="">Todos</option>
                        <option th:each="ed : ${editais}" th:value="${ed.id}" th:text="${ed.descricao}" th:selected="${ed.id == selectedEdital}"></option>
                    </select>
                </label>
            </div>
            <div>
                <label style="display:flex; flex-direction:column; gap:4px; font-size:0.9rem;">
                    <span class="muted">Campus:</span>
                    <select id="filterCampus" name="campusId" onchange="filterByCampus()">
                        <option value="">Todos</option>
                        <option th:each="cp : ${campuses}" th:value="${cp.id}" th:text="${cp.nome}" th:selected="${cp.id == selectedCampus}"></option>
                    </select>
                </label>
            </div>
            <button type="button" class="btn btn-primary" onclick="applyFilters()">Filtrar</button>
        </div>

        <!-- Alertas -->
        <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <!-- Lista de Campus-Edital agrupada por turno -->
        <div th:if="${#lists.isEmpty(campusEditais)}" class="empty-state">
            <p>Nenhum campus-edital encontrado com os filtros selecionados.</p>
        </div>

        <div th:each="ce : ${campusEditais}" class="turno-section">
            <div class="turno-header">
                <div>
                    <h3 th:text="${ce.campus.nome + ' - Edital ' + ce.edital.descricao}"></h3>
                    <p style="margin:4px 0 0 0; color:#666; font-size:0.9rem;" th:text="'ID: ' + ${ce.id}"></p>
                </div>
                <div class="actions">
                    <button type="button" class="btn btn-sm btn-primary" th:onclick="'openAddTurnoForm(' + ${ce.id} + ')'">+ Adicionar Turno</button>
                </div>
            </div>

            <!-- Turnos existentes -->
            <div th:if="${not #lists.isEmpty(ce.turnos)}" style="margin-bottom:16px;">
                <table class="turno-table">
                    <thead>
                        <tr>
                            <th>Turno</th>
                            <th style="text-align:right;">Vagas Reservadas</th>
                            <th style="text-align:right;">Ocupadas Reservadas</th>
                            <th style="text-align:right;">Vagas Ampla</th>
                            <th style="text-align:right;">Ocupadas Ampla</th>
                            <th style="text-align:right;">Class. Masc.</th>
                            <th style="text-align:right;">Class. Fem.</th>
                            <th style="text-align:right;">Habit. Masc.</th>
                            <th style="text-align:right;">Habit. Fem.</th>
                            <th style="text-align:center;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="turno : ${ce.turnos}">
                            <td th:text="${turno.turno}">MANHA</td>
                            <td style="text-align:right;" th:text="${turno.numeroVagasReservadas}">0</td>
                            <td style="text-align:right;" th:text="${turno.vagasReservadasOcupadas}">0</td>
                            <td style="text-align:right;" th:text="${turno.numeroVagasAmplaConcorrencia}">0</td>
                            <td style="text-align:right;" th:text="${turno.vagasAmplaOcupadas}">0</td>
                            <td style="text-align:right;" th:text="${turno.numeroVagasClassificadoMasculino}">0</td>
                            <td style="text-align:right;" th:text="${turno.numeroVagasClassificadoFeminino}">0</td>
                            <td style="text-align:right;" th:text="${turno.numeroVagasHabilitadoMasculino}">0</td>
                            <td style="text-align:right;" th:text="${turno.numeroVagasHabilitadoFeminino}">0</td>
                            <td style="text-align:center;">
                                <div class="actions">
                                    <button type="button" class="btn btn-sm btn-edit" th:onclick="'openEditTurnoForm(' + ${turno.id} + ',' + ${ce.id} + ')'">Editar</button>
                                    <button type="button" class="btn btn-sm btn-delete" th:onclick="'deleteTurno(' + ${turno.id} + ',' + ${ce.id} + ')'">Deletar</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div th:if="${#lists.isEmpty(ce.turnos)}" class="empty-state" style="padding:20px;">
                <p>Nenhum turno configurado ainda.</p>
            </div>

            <!-- Formulário para adicionar turno (escondido inicialmente) -->
            <div th:id="'add-turno-form-' + ${ce.id}" class="add-turno-form" style="display:none;">
                <h4>Adicionar Novo Turno</h4>
                <form th:action="@{/campus-edital-turno/create}" method="post">
                    <input type="hidden" name="campusEditalId" th:value="${ce.id}" />
                    <div class="form-row">
                        <label>
                            <span class="muted">Turno</span>
                            <select name="turno" required>
                                <option value="" disabled selected>Selecione um turno</option>
                                <option value="MANHA">Manhã</option>
                                <option value="TARDE">Tarde</option>
                                <option value="NOITE">Noite</option>
                                <option value="UNICO">Único</option>
                                <option value="INTEGRAL">Integral</option>
                            </select>
                        </label>
                        <label>
                            <span class="muted">Vagas Reservadas</span>
                            <input type="number" name="numeroVagasReservadas" value="0" min="0" required />
                        </label>
                        <label>
                            <span class="muted">Vagas Ampla Concorrência</span>
                            <input type="number" name="numeroVagasAmplaConcorrencia" value="0" min="0" required />
                        </label>
                    </div>
                    <div class="form-row">
                        <label>
                            <span class="muted">Vagas Classificados - Masculino</span>
                            <input type="number" name="numeroVagasClassificadoMasculino" value="0" min="0" />
                        </label>
                        <label>
                            <span class="muted">Vagas Classificados - Feminino</span>
                            <input type="number" name="numeroVagasClassificadoFeminino" value="0" min="0" />
                        </label>
                        <label>
                            <span class="muted">Vagas Habilitados - Masculino</span>
                            <input type="number" name="numeroVagasHabilitadoMasculino" value="0" min="0" />
                        </label>
                        <label>
                            <span class="muted">Vagas Habilitados - Feminino</span>
                            <input type="number" name="numeroVagasHabilitadoFeminino" value="0" min="0" />
                        </label>
                    </div>
                    <div class="form-row">
                        <button type="submit" class="btn btn-primary">Salvar Turno</button>
                        <button type="button" class="btn btn-ghost" th:onclick="'closeTurnoForm(' + ${ce.id} + ')'">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function applyFilters() {
    const editalId = document.getElementById('filterEdital')?.value || '';
    const campusId = document.getElementById('filterCampus')?.value || '';
    const params = new URLSearchParams();
    if (editalId) params.append('editalId', editalId);
    if (campusId) params.append('campusId', campusId);
    window.location.href = '/campus-edital-turno/list?' + params.toString();
}

function filterByEdital() {
    applyFilters();
}

function filterByCampus() {
    applyFilters();
}

function openAddTurnoForm(ceId) {
    const form = document.getElementById('add-turno-form-' + ceId);
    if (form) form.style.display = 'block';
}

function closeTurnoForm(ceId) {
    const form = document.getElementById('add-turno-form-' + ceId);
    if (form) form.style.display = 'none';
}

function openEditTurnoForm(turnoId, ceId) {
    // Implementar modal ou redirecionar para página de edição
    alert('Editar turno ' + turnoId + ' - implementar em seguida');
}

function deleteTurno(turnoId, ceId) {
    if (confirm('Tem certeza que deseja deletar este turno? As vagas serão zeradas.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/campus-edital-turno/' + turnoId + '/delete';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'ceId';
        input.value = ceId;
        form.appendChild(input);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
</body>
</html>

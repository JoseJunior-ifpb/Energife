<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Lista de Candidatos</title>
    <link rel="stylesheet" href="/css/styles.css" />
    
</head>
<body>
<div class="container-app">
    <div class="hero">
        <div class="title">
            <h1>Lista de Candidatos</h1>
            <div class="subtitle">Visualize e gerencie os candidatos cadastrados</div>
        </div>
        <div class="toolbar">
            <a th:href="@{/candidatos/novo}" class="btn btn-primary">Novo Candidato</a>
            <a th:href="@{/}" class="btn btn-ghost">Home</a>
            <a th:href="@{/motivos/list}" class="btn btn-ghost">Motivos</a>
            <div style="margin-left:12px;display:flex;align-items:center;gap:8px">
                <label class="muted" style="font-size:0.9rem">Ordenar por:</label>
                <a th:href="@{/candidatos/list(order='newest', q=${q}, campusId=${selectedCampus}, genero=${selectedGenero}, idade=${selectedIdade}, habilitado=${selectedHabilitado}, turno=${selectedTurno})}" th:classappend="${selectedOrder=='newest'} ? ' btn-primary' : ' btn-ghost'" class="btn">Mais recentes</a>
                <a th:href="@{/candidatos/list(order='oldest', q=${q}, campusId=${selectedCampus}, genero=${selectedGenero}, idade=${selectedIdade}, habilitado=${selectedHabilitado}, turno=${selectedTurno})}" th:classappend="${selectedOrder=='oldest'} ? ' btn-primary' : ' btn-ghost'" class="btn">Mais antigos</a>
            </div>
            <form th:action="@{/candidatos/list}" method="get" style="margin-left:12px; display:inline-flex; align-items:center; gap:8px">
                <input type="hidden" name="order" th:value="${selectedOrder}" />
                <input type="hidden" name="q" th:value="${q}" />
                <label class="muted">Gênero:</label>
                <select name="genero">
                    <option value="">Todos</option>
                    <option value="M" th:selected="${selectedGenero == 'M'}">Masculino</option>
                    <option value="F" th:selected="${selectedGenero == 'F'}">Feminino</option>
                </select>
                <label class="muted">Idade:</label>
                <select name="idade">
                    <option value="">Todos</option>
                    <option value="maior" th:selected="${selectedIdade == 'maior'}">Maior ou igual 18</option>
                    <option value="menor" th:selected="${selectedIdade == 'menor'}">Menor que 18</option>
                </select>
                <label class="muted">Campus:</label>
                <select name="campusId">
                    <option value="">Todos</option>
                    <option th:each="cp : ${campuses}" th:value="${cp.id}" th:text="${cp.nome}" th:selected="${cp.id == selectedCampus}"></option>
                </select>
                <label class="muted">Turno:</label>
                <select name="turno">
                    <option value="">Todos</option>
                    <option th:each="t : ${turnos}" th:value="${t}" th:text="${t}" th:selected="${t == selectedTurno}"></option>
                </select>
                <label class="muted">Habilitado:</label>
                <select name="habilitado">
                    <option value="">Todos</option>
                    <option value="sim" th:selected="${selectedClassificado == 'sim'}">Classificados</option>
                    <option value="nao" th:selected="${selectedClassificado == 'nao'}">Não classificados</option>
                </select>
                <button type="submit" class="btn btn-ghost">Filtrar</button>
                <button type="submit" class="btn btn-primary" formtarget="_blank" formaction="/candidatos/report">Gerar relatório</button>
            </form>

            <form th:action="@{/candidatos/list}" method="get" class="search-form" style="display:flex; align-items:center; gap:8px;">
                <input type="hidden" name="order" th:value="${selectedOrder}" />
                <input type="hidden" name="genero" th:value="${selectedGenero}" />
                <input type="hidden" name="idade" th:value="${selectedIdade}" />
                <input type="hidden" name="habilitado" th:value="${selectedHabilitado}" />
                
                <div class="search-input-container"> 
                    <input 
                        type="text" 
                        name="q" 
                        placeholder="Pesquisar por nome, campus ou CPF..." 
                        th:value="${q}"
                        class="search-input"
                    /> 
                </div> 
                
                <button type="submit" class="search-button">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    <span class="search-text">Pesquisar</span>
                </button>
            </form>

            <form th:action="@{/candidatos/import}" method="post" enctype="multipart/form-data" style="margin-left:12px;display:flex;align-items:center;gap:8px">
                <input type="text" name="editalDescricao" placeholder="Digite o número/descrição do edital (ex: 'edital n°25 2025.1')" required />
                <input type="file" name="file" accept=".xlsx" required />
                <button type="submit" class="btn btn-info">Importar XLSX</button>
            </form>

            <form th:action="@{/candidatos/delete-all}" method="post" style="margin-left:12px;display:flex;align-items:center;">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Tem certeza que deseja apagar todos os candidatos?');">Apagar todos</button>
            </form>
            <button id="btn-duplicados" class="btn btn-ghost" style="margin-left:12px">Candidatos repetidos</button>
        </div>
    </div>

    <div class="card">
        <div class="table-wrap">
            <table class="styled">
                <thead>
                <tr>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>Campus</th>
                    <th>Edital</th>
                    <th>Data Nasc.</th>
                    <th>Turno</th>
                    <th>Gênero</th>
                    <th>Inscrição</th>
                    <th>Situação</th>
                    <th>Motivo</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="cand : ${candidatos}">
                    <td th:text="${cand.nome}">Nome</td>
                    <td th:text="${cand.cpf}">000</td>
                    <td th:text="${cand.campus != null ? cand.campus.nome : '-'}" class="muted">Campus</td>
                    <td th:text="${cand.edital != null ? cand.edital.descricao : '-'}" class="muted">-</td>
                    <td th:text="${cand.dataNascimento}">-</td>
                    <td th:text="${cand.turno}">-</td>
                    <td th:text="${cand.genero}">-</td>
                    <td><div th:text="${cand.dataInscricao}">-</div><div class="muted" th:text="${cand.horaInscricao}">-</div></td>
                    <td>
                        <form th:action="@{'/candidatos/' + ${cand.id} + '/habilitar'}" method="post" class="situacao-form">
                            <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <select name="situacao" th:onchange="this.form.closest('tr').querySelector('.motivo-input').style.display = (this.value == 'nao' || this.value == 'eliminado') ? 'table-cell' : 'none';">
                                <option th:value="'classificado'" th:selected="${cand.situacao != null and cand.situacao.name() == 'CLASSIFICADO'}">Classificado</option>
                                <option th:value="'nao'" th:selected="${cand.situacao != null and cand.situacao.name() == 'NAO_CLASSIFICADO'}">Não classificado</option>
                                <option th:value="'habilitado'" th:selected="${cand.situacao != null and cand.situacao.name() == 'HABILITADO'}">Habilitado</option>
                                <option th:value="'eliminado'" th:selected="${cand.situacao != null and cand.situacao.name() == 'ELIMINADO'}">Eliminado</option>
                                <!-- Opção para Cadastro de Reserva (suplente) - desabilitado se não houver vagas -->
                                <option th:value="'cadastro'" 
                                    th:selected="${cand.situacao != null and cand.situacao.name() == 'CADASTRO_RESERVA'}"
                                    th:disabled="${cand.campus == null or cand.campus.numeroVagasCadastroReserva == null or cand.campus.numeroVagasCadastroReserva <= 0}"
                                    th:title="${(cand.campus != null and (cand.campus.numeroVagasCadastroReserva == null or cand.campus.numeroVagasCadastroReserva <= 0)) ? 'Nenhuma vaga de cadastro de reserva configurada' : ''}">
                                    Cadastro de Reserva
                                </option>
                            </select>
                            <!-- no hidden situacao: only the select should send the chosen situacao -->
                            <button type="submit" class="btn btn-sm">Salvar</button>
                        </form>
                    </td>
                    <td class="motivo-input" th:style="${cand.situacao == null or cand.situacao.name() == 'NAO_CLASSIFICADO' or cand.situacao.name() == 'ELIMINADO'} ? 'display:table-cell' : 'display:none'">
                        <form th:action="@{'/candidatos/' + ${cand.id} + '/habilitar'}" method="post">
                            <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <!-- situacao will be appended dynamically by JS when the motivo form is submitted
                                 (so it matches the currently-selected status in the situacao select above) -->
                            <select name="motivo">
                                <option value="" th:selected="${cand.motivoNaoClassificacao == null || cand.motivoNaoClassificacao == ''}">Selecione um motivo</option>
                                <option th:each="m : ${motivos}" th:value="${m.descricao}"
                                    th:text="${m.descricao}"
                                    th:selected="${m.descricao == cand.motivoNaoClassificacao}"></option>
                            </select>
                            <button type="submit" class="btn btn-sm">Salvar</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(candidatos)}">
                    <td colspan="11" class="text-center muted">Nenhum candidato encontrado.</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="pagination" style="padding:12px;display:flex;align-items:center;gap:8px;justify-content-center"
             th:with="total=${candidatosPage.totalPages},
                      start=${currentPage - 2 >= 0 ? currentPage - 2 : 0},
                      end=${currentPage + 2 <= total - 1 ? currentPage + 2 : total - 1}">

            <div>
                <a th:if="${currentPage > 0}" th:href="@{/candidatos/list(page=${currentPage-1},size=${pageSize},order=${selectedOrder},q=${q},campusId=${selectedCampus},genero=${selectedGenero},idade=${selectedIdade},habilitado=${selectedHabilitado},turno=${selectedTurno})}" class="btn">&laquo; Anterior</a>
                <span th:if="${currentPage == 0}" class="btn disabled">&laquo; Anterior</span>
            </div>

            <div style="display:flex;gap:6px;align-items:center;">
                <a th:if="${start > 0}" th:href="@{/candidatos/list(page=0,size=${pageSize},order=${selectedOrder},q=${q},campusId=${selectedCampus},genero=${selectedGenero},idade=${selectedIdade},habilitado=${selectedHabilitado},turno=${selectedTurno})}" class="btn btn-ghost">1</a>
                <span th:if="${start > 1}" class="muted">&hellip;</span>

                <span th:each="i : ${#numbers.sequence(start, end)}">
                    <a th:href="@{/candidatos/list(page=${i},size=${pageSize},order=${selectedOrder},q=${q},campusId=${selectedCampus},genero=${selectedGenero},idade=${selectedIdade},habilitado=${selectedHabilitado},turno=${selectedTurno})}"
                       th:classappend="${i == currentPage} ? ' btn-primary' : ' btn-ghost'"
                       th:text="${i+1}">1</a>
                </span>

                <span th:if="${end < total - 2}" class="muted">&hellip;</span>
                <a th:if="${end < total - 1}" th:href="@{/candidatos/list(page=${total-1},size=${pageSize},order=${selectedOrder},q=${q},campusId=${selectedCampus},genero=${selectedGenero},idade=${selectedIdade},habilitado=${selectedHabilitado},turno=${selectedTurno})}" class="btn btn-ghost" th:text="${total}">N</a>
            </div>

            <div>
                <a th:if="${currentPage < (total - 1)}" th:href="@{/candidatos/list(page=${currentPage+1},size=${pageSize},order=${selectedOrder},q=${q},campusId=${selectedCampus},genero=${selectedGenero},idade=${selectedIdade},habilitado=${selectedHabilitado},turno=${selectedTurno})}" class="btn">Próximo &raquo;</a>
                <span th:if="${currentPage >= (total - 1)}" class="btn disabled">Próximo &raquo;</span>
            </div>
        </div>
    </div>
</div>
</body>
<!-- Modal para listar candidatos repetidos -->
<div id="modal-duplicados" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff;max-width:800px;width:95%;max-height:80vh;overflow:auto;border-radius:6px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.3);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="margin:0">Candidatos repetidos</h3>
            <button id="close-duplicados" class="btn btn-ghost">Fechar</button>
        </div>
        <div id="duplicados-content">
            <table style="width:100%;border-collapse:collapse">
                <thead>
                    <tr>
                        <th style="text-align:left;padding:8px;border-bottom:1px solid #ddd">CPF</th>
                        <th style="text-align:right;padding:8px;border-bottom:1px solid #ddd">Total de repetições</th>
                        <th style="text-align:center;padding:8px;border-bottom:1px solid #ddd">Ações</th>
                    </tr>
                </thead>
                <tbody id="duplicados-tbody">
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Intercept motivo forms and submit via AJAX to avoid full page reload
    document.querySelectorAll('.motivo-input form').forEach(function(form) {
                form.addEventListener('submit', async function(ev) {
            ev.preventDefault();
            const tr = form.closest('tr');
            // Show a saving indicator
            let indicator = form.querySelector('.save-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'save-indicator muted';
                indicator.style.marginLeft = '8px';
                form.appendChild(indicator);
            }
            indicator.textContent = 'Salvando...';

                try {
                const fd = new FormData(form);
                    // ensure the 'situacao' field is present and matches the selected situacao for this row
                    // the situacao select is in the neighboring situacao-form; find it and add/override value
                    try {
                        const situacaoSelect = tr.querySelector('select[name="situacao"]');
                        if (situacaoSelect) {
                            // ensure the FormData contains the chosen situacao
                            fd.set('situacao', situacaoSelect.value);
                        }
                    } catch (err) {
                        // ignore - fallback will submit whatever the form already had
                    }
                const saveButton = form.querySelector('button[type=submit]');
                if (saveButton) saveButton.disabled = true;
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: fd,
                    credentials: 'same-origin'
                });
                if (saveButton) saveButton.disabled = false;
                if (!res.ok) {
                    indicator.textContent = 'Erro';
                    setTimeout(() => indicator.textContent = '', 2000);
                    alert('Erro ao salvar motivo (status ' + res.status + ')');
                    return;
                }

                indicator.textContent = 'Salvo';
                tr.style.transition = 'background-color 0.4s';
                tr.style.backgroundColor = '#e6ffe6';
                setTimeout(function() { tr.style.backgroundColor = ''; }, 700);
                setTimeout(() => { if (indicator) indicator.textContent = ''; }, 1200);
            } catch (err) {
                indicator.textContent = 'Erro rede';
                setTimeout(() => indicator.textContent = '', 2000);
                console.error(err);
                alert('Erro de rede ao salvar motivo');
            }
        });
    });
    // Intercept situacao forms and submit via AJAX as well
    document.querySelectorAll('.situacao-form').forEach(function(form) {
        form.addEventListener('submit', async function(ev) {
            ev.preventDefault();
            const tr = form.closest('tr');
            let indicator = form.querySelector('.save-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'save-indicator muted';
                indicator.style.marginLeft = '8px';
                form.appendChild(indicator);
            }
            indicator.textContent = 'Salvando...';

            // remove any previous feedback message in this row
            let prevFeedback = tr.querySelector('.feedback-message');
            if (prevFeedback) prevFeedback.remove();

            try {
                const fd = new FormData(form);
                const res = await fetch(form.action, {
                    method: 'POST',
                    body: fd,
                    credentials: 'same-origin'
                });
                if (!res.ok) {
                    indicator.textContent = 'Erro';
                    setTimeout(() => indicator.textContent = '', 2000);
                    alert('Erro ao salvar situação (status ' + res.status + ')');
                    return;
                }

                // parse JSON response from server
                let json = null;
                try {
                    json = await res.json();
                } catch (e) {
                    // not JSON — fall back to success
                    json = { sucesso: true };
                }

                // If server indicates failure, show message
                if (json && json.sucesso === false) {
                    indicator.textContent = 'Erro';
                    setTimeout(() => indicator.textContent = '', 2000);
                    const errMsg = json.mensagem || json.error || 'Erro ao atualizar situação';
                    alert(errMsg);
                    return;
                }

                // If the selected situacao is 'nao' or 'eliminado', show motivo cell; otherwise hide it
                const situacaoVal = (new FormData(form)).get('situacao');
                const motivoCell = tr.querySelector('.motivo-input');
                if (motivoCell) {
                    motivoCell.style.display = (situacaoVal === 'nao' || situacaoVal === 'eliminado') ? 'table-cell' : 'none';
                }

                indicator.textContent = 'Salvo';

                // show transient feedback about remaining vacancies when present
                if (json && (json.vagasDisponiveis !== undefined || json.mensagem)) {
                    const alert = document.createElement('div');
                    alert.className = json.sucesso ? 'alert alert-success' : 'alert alert-warning';
                    // Create alert content
                    const content = document.createElement('div');
                    content.className = 'alert-content';
                    
                    // Add title if available
                    const title = document.createElement('div');
                    title.className = 'alert-title';
                    title.textContent = json.sucesso ? 'Sucesso' : 'Atenção';
                    content.appendChild(title);
                    
                    // Add message
                    const message = document.createElement('div');
                    message.className = 'alert-message';
                    if (json.vagasDisponiveis !== undefined && json.campusNome) {
                        const tipo = json.tipoVaga ? (' (' + json.tipoVaga + ')') : '';
                        message.textContent = `Vagas restantes em ${json.campusNome}${tipo}: ${json.vagasDisponiveis}`;
                    } else if (json.mensagem) {
                        message.textContent = json.mensagem;
                    } else {
                        message.textContent = 'Atualizado com sucesso';
                    }
                    content.appendChild(message);
                    
                    // Create alert icon (success check or warning triangle)
                    const icon = document.createElement('div');
                    icon.className = 'alert-icon';
                    icon.innerHTML = json.sucesso ? 
                        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12l2 2 4-4"></path></svg>' :
                        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
                    
                    // Add close button
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'alert-close';
                    closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                    closeBtn.onclick = () => alert.remove();
                    
                    // Assemble alert
                    alert.appendChild(icon);
                    alert.appendChild(content);
                    alert.appendChild(closeBtn);
                    
                    // append alert to the cell that contains the situacao form (it's visible)
                    const formCell = form.closest('td') || tr.querySelector('td:last-child') || tr;
                    formCell.appendChild(alert);
                    // fade out after a few seconds
                    setTimeout(() => {
                        alert.style.transition = 'opacity 0.6s, transform 0.6s';
                        alert.style.opacity = '0';
                        alert.style.transform = 'translateY(-10px)';
                        setTimeout(() => alert.remove(), 700);
                    }, 5000);
                }

                tr.style.transition = 'background-color 0.4s';
                tr.style.backgroundColor = '#e6ffe6';
                setTimeout(function() { tr.style.backgroundColor = ''; }, 700);
                setTimeout(() => { if (indicator) indicator.textContent = ''; }, 1200);
            } catch (err) {
                indicator.textContent = 'Erro rede';
                setTimeout(() => indicator.textContent = '', 2000);
                console.error(err);
                alert('Erro de rede ao salvar situação');
            }
        });
    });

    // Handle "Candidatos repetidos" button: fetch duplicates and show modal
    const btnDup = document.getElementById('btn-duplicados');
    const modalDup = document.getElementById('modal-duplicados');
    const closeDup = document.getElementById('close-duplicados');
    const tbodyDup = document.getElementById('duplicados-tbody');
    if (btnDup && modalDup && closeDup && tbodyDup) {
        btnDup.addEventListener('click', async function() {
            try {
                btnDup.disabled = true;
                btnDup.textContent = 'Carregando...';
                const res = await fetch('/candidatos/repetidos', { credentials: 'same-origin' });
                btnDup.disabled = false;
                btnDup.textContent = 'Candidatos repetidos';
                if (!res.ok) {
                    alert('Erro ao buscar candidatos repetidos (status ' + res.status + ')');
                    return;
                }
                const data = await res.json();
                // clear tbody
                tbodyDup.innerHTML = '';
                if (!data || data.length === 0) {
                    tbodyDup.innerHTML = '<tr><td colspan="2" style="padding:8px">Nenhum CPF duplicado encontrado.</td></tr>';
                } else {
                    data.forEach(function(row) {
                        const tr = document.createElement('tr');
                        const tdCpf = document.createElement('td');
                        tdCpf.style.padding = '8px';
                        tdCpf.textContent = row.cpf || '-';
                        const tdCount = document.createElement('td');
                        tdCount.style.padding = '8px';
                        tdCount.style.textAlign = 'right';
                        tdCount.textContent = row.total != null ? row.total : '-';

                        const tdAction = document.createElement('td');
                        tdAction.style.padding = '8px';
                        tdAction.style.textAlign = 'center';
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-ghost';
                        btn.title = 'Buscar por este CPF';
                        // simple magnifier SVG
                        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>';
                        btn.addEventListener('click', function() {
                            // close modal and navigate to lista with q=cpf
                            modalDup.style.display = 'none';
                            const cpf = row.cpf || '';
                            // navigate to list page with query
                            const url = '/candidatos/list?q=' + encodeURIComponent(cpf);
                            window.location.href = url;
                        });
                        tdAction.appendChild(btn);

                        tr.appendChild(tdCpf);
                        tr.appendChild(tdCount);
                        tr.appendChild(tdAction);
                        tbodyDup.appendChild(tr);
                    });
                }
                modalDup.style.display = 'flex';
            } catch (err) {
                btnDup.disabled = false;
                btnDup.textContent = 'Candidatos repetidos';
                console.error(err);
                alert('Erro ao buscar candidatos repetidos');
            }
        });

        closeDup.addEventListener('click', function() { modalDup.style.display = 'none'; });
        modalDup.addEventListener('click', function(ev) { if (ev.target === modalDup) modalDup.style.display = 'none'; });
    }
});
</script>
</html>
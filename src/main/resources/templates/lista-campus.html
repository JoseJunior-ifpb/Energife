<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Lista de Campus</title>
    <style>
         /* Reset e configurações básicas */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container-app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Hero Section */
        .hero {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .title h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .toolbar {
            display: flex;
            gap: 10px;
        }

        /* Botões */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-ghost {
            background-color: transparent;
            color: #7f8c8d;
            border: 1px solid #bdc3c7;
        }

        .btn-ghost:hover {
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        /* Cartões */
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Grid de Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Tabela */
        .table-wrap {
            overflow-x: auto;
        }

        table.styled {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table.styled thead {
            background-color: #2c3e50;
            color: white;
        }

        table.styled th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        table.styled td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        table.styled tbody tr {
            transition: background-color 0.3s ease;
        }

        table.styled tbody tr:hover {
            background-color: #f8f9fa;
        }

        table.styled tbody tr.updating {
            background-color: #fff9e6;
        }

        table.styled tbody tr.success {
            background-color: #e8f6ef;
        }

        table.styled tbody tr.error {
            background-color: #fdeded;
        }

        /* Badges de Status */
        .status-badge span {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Formulários */
        .edit-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .number-input {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .number-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .saving-indicator {
            color: #3498db;
            font-size: 0.8rem;
            display: none;
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Informações sobre Vagas */
        .vaga-info {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .vaga-item {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .vaga-reservada {
            background-color: #e8f4fc;
            border-left-color: #3498db;
        }

        .vaga-ampla {
            background-color: #f0f7f0;
            border-left-color: #27ae60;
        }

        .vaga-item strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .vaga-item div {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        /* Mensagens */
        .success-message, .error-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        /* Texto e Utilitários */
        .muted {
            color: #7f8c8d;
        }

        .text-center {
            text-align: center;
        }

        strong {
            color: #2c3e50;
        }

        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .hero {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .vaga-info {
                flex-direction: column;
            }
            
            .edit-form {
                flex-direction: column;
                align-items: flex-start;
            }
            
            table.styled {
                font-size: 0.85rem;
            }
            
            table.styled th, 
            table.styled td {
                padding: 10px 8px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .container-app {
                padding: 10px;
            }
        }
    </style>
    
    
</head>
<body>
<div class="container-app">
    <div class="hero">
        <div class="title">
            <h1>Lista de Campus</h1>
            <div class="subtitle">Gerencie os campus e suas vagas</div>
        </div>
        <div class="toolbar">
            <a th:href="@{/campus/novo}" class="btn btn-primary">Novo Campus</a>
            <a th:href="@{/}" class="btn btn-ghost">Home</a>
        </div>
    </div>

    <!-- Mensagens dinâmicas -->
    <div id="successMessage" class="success-message"></div>
    <div id="errorMessage" class="error-message"></div>

    <!-- Estatísticas Gerais -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" th:text="${campuses.size()}">0</div>
            <div class="stat-label">Total de Campus</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalReservadas" th:text="${#aggregates.sum(campuses.![numeroVagasReservadas])}">0</div>
            <div class="stat-label">Vagas Reservadas Totais</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalAmpla" th:text="${#aggregates.sum(campuses.![numeroVagasAmplaConcorrencia])}">0</div>
            <div class="stat-label">Vagas Ampla Concorrência Totais</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalGeral" th:text="${#aggregates.sum(campuses.![numeroVagasReservadas + numeroVagasAmplaConcorrencia])}">0</div>
            <div class="stat-label">Total de Vagas</div>
        </div>
    </div>

    <div class="card">
        <div class="table-wrap">
            <table class="styled">
                <thead>
                <tr>
                    <th>Campus</th>
                    <th>Vagas Reservadas</th>
                    <th>Vagas Ampla Concorrência</th>
                    <th>Total de Vagas</th>
                    <th>Vagas Ocupadas</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody id="campusTableBody">
                <tr th:each="campus : ${campuses}" th:id="'campus-row-' + ${campus.id}" class="campus-row">
                    <td>
                        <strong th:text="${campus.nome}">Nome do Campus</strong>
                    </td>
                    <td>
                        <div>
                            <span th:id="'vagas-reservadas-ocupadas-' + ${campus.id}" th:text="${campus.vagasReservadasOcupadas}">0</span> / 
                            <span th:id="'vagas-reservadas-total-' + ${campus.id}" th:text="${campus.numeroVagasReservadas}">0</span>
                            <div class="muted" style="font-size: 0.8rem;">
                                <span th:id="'vagas-reservadas-disponiveis-' + ${campus.id}" th:text="${campus.vagasReservadasDisponiveis}">0</span> disponíveis
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <span th:id="'vagas-ampla-ocupadas-' + ${campus.id}" th:text="${campus.vagasAmplaOcupadas}">0</span> / 
                            <span th:id="'vagas-ampla-total-' + ${campus.id}" th:text="${campus.numeroVagasAmplaConcorrencia}">0</span>
                            <div class="muted" style="font-size: 0.8rem;">
                                <span th:id="'vagas-ampla-disponiveis-' + ${campus.id}" th:text="${campus.vagasAmplaDisponiveis}">0</span> disponíveis
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong th:id="'total-vagas-' + ${campus.id}" th:text="${campus.numeroVagasReservadas + campus.numeroVagasAmplaConcorrencia}">0</strong>
                    </td>
                    <td>
                        <strong th:id="'total-ocupadas-' + ${campus.id}" th:text="${campus.vagasReservadasOcupadas + campus.vagasAmplaOcupadas}">0</strong>
                    </td>
                    <td>
                        <!-- Status simplificado - será atualizado via JavaScript -->
                        <span th:id="'status-' + ${campus.id}" class="status-badge">
                            <span th:if="${campus.vagasReservadasDisponiveis > 0 and campus.vagasAmplaDisponiveis > 0}" 
                                  class="status-success">Vagas Disponíveis</span>
                            <span th:if="${(campus.vagasReservadasDisponiveis <= 0 and campus.vagasAmplaDisponiveis > 0) or (campus.vagasReservadasDisponiveis > 0 and campus.vagasAmplaDisponiveis <= 0)}" 
                                  class="status-warning">Vagas Limitadas</span>
                            <span th:if="${campus.vagasReservadasDisponiveis <= 0 and campus.vagasAmplaDisponiveis <= 0}" 
                                  class="status-danger">Sem Vagas</span>
                        </span>
                    </td>
                    <td>
                        <div class="actions">
                            <!-- Formulário de Edição com AJAX -->
                            <form th:id="'edit-form-' + ${campus.id}" class="edit-form">
                                <input type="number" th:id="'input-reservadas-' + ${campus.id}"
                                    th:value="${campus.numeroVagasReservadas}" 
                                    class="number-input" 
                                    min="0" required />
                                <input type="number" th:id="'input-ampla-' + ${campus.id}"
                                    th:value="${campus.numeroVagasAmplaConcorrencia}" 
                                    class="number-input" 
                                    min="0" required />
                                <button type="button" 
                                        th:data-id="${campus.id}"
                                        class="btn btn-sm btn-primary btn-atualizar">
                                    Atualizar
                                </button>
                                <span th:id="'saving-' + ${campus.id}" class="saving-indicator">Salvando...</span>
                            </form>
                            
                            <!-- Botão Excluir com AJAX -->
                            <button type="button" 
                                    th:data-id="${campus.id}"
                                    th:data-nome="${campus.nome}"
                                    class="btn btn-sm btn-danger btn-excluir">
                                Excluir
                            </button>
                        </div>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(campuses)}">
                    <td colspan="7" class="text-center muted">
                        Nenhum campus cadastrado. 
                        <a th:href="@{/campus/novo}">Cadastre o primeiro campus</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Informações -->
    <div class="card" style="margin-top: 20px;">
        <h3>Informações sobre as Vagas</h3>
        <div class="vaga-info">
            <div class="vaga-item vaga-reservada">
                <strong>Vagas Reservadas</strong>
                <div>Destinadas a candidatas do sexo feminino</div>
            </div>
            <div class="vaga-item vaga-ampla">
                <strong>Vagas Ampla Concorrência</strong>
                <div>Destinadas a candidatos do sexo masculino</div>
            </div>
        </div>
        <div style="margin-top: 16px;">
            <p><strong>Nota:</strong> O sistema determina automaticamente o tipo de vaga baseado no gênero do candidato.</p>
            <ul>
                <li><strong>Feminino</strong> → Concorre às <strong>Vagas Reservadas</strong></li>
                <li><strong>Masculino</strong> → Concorre às <strong>Vagas Ampla Concorrência</strong></li>
            </ul>
        </div>
    </div>
</div>

<script>
// CSRF Token (se disponível)
const _csrf = {
    parameterName: /*[[${_csrf?.parameterName}]]*/ '_csrf',
    token: /*[[${_csrf?.token}]]*/ ''
};

// Função para mostrar mensagem
function showMessage(elementId, message, isError = false) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.style.display = 'block';
    
    if (isError) {
        element.className = 'error-message';
    } else {
        element.className = 'success-message';
    }
    
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}

// Função para atualizar campus via AJAX
async function atualizarCampus(campusId) {
    const reservadasInput = document.getElementById('input-reservadas-' + campusId);
    const amplaInput = document.getElementById('input-ampla-' + campusId);
    const savingIndicator = document.getElementById('saving-' + campusId);
    const row = document.getElementById('campus-row-' + campusId);
    
    const numeroVagasReservadas = parseInt(reservadasInput.value) || 0;
    const numeroVagasAmplaConcorrencia = parseInt(amplaInput.value) || 0;
    
    // Validação
    if (numeroVagasReservadas < 0 || numeroVagasAmplaConcorrencia < 0) {
        showMessage('errorMessage', 'O número de vagas não pode ser negativo.', true);
        return;
    }
    
    if (numeroVagasReservadas === 0 && numeroVagasAmplaConcorrencia === 0) {
        if (!confirm('Ambos os tipos de vaga estão com 0 vagas. Tem certeza que deseja continuar?')) {
            return;
        }
    }
    
    // Mostrar indicador de salvamento
    savingIndicator.style.display = 'inline';
    row.classList.add('updating');
    
    try {
        const formData = new URLSearchParams();
        formData.append('numeroVagasReservadas', numeroVagasReservadas);
        formData.append('numeroVagasAmplaConcorrencia', numeroVagasAmplaConcorrencia);
        if (_csrf.parameterName && _csrf.token) {
            formData.append(_csrf.parameterName, _csrf.token);
        }
        
        const response = await fetch('/campus/' + campusId + '/editar-ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Atualizar a linha com os novos dados
            updateCampusRow(campusId, result.campus);
            row.classList.remove('updating');
            row.classList.add('success');
            showMessage('successMessage', 'Campus atualizado com sucesso!');
            
            // Atualizar estatísticas gerais
            updateEstatisticas();
            
            // Remover classe de sucesso após 2 segundos
            setTimeout(() => {
                row.classList.remove('success');
            }, 2000);
        } else {
            showMessage('errorMessage', 'Erro ao atualizar campus: ' + result.error, true);
            row.classList.remove('updating');
            row.classList.add('error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showMessage('errorMessage', 'Erro de rede ao atualizar campus.', true);
        row.classList.remove('updating');
        row.classList.add('error');
    } finally {
        savingIndicator.style.display = 'none';
    }
}

// Função para atualizar os dados da linha
function updateCampusRow(campusId, campusData) {
    // Atualizar vagas reservadas
    document.getElementById('vagas-reservadas-total-' + campusId).textContent = campusData.numeroVagasReservadas;
    document.getElementById('vagas-reservadas-ocupadas-' + campusId).textContent = campusData.vagasReservadasOcupadas;
    document.getElementById('vagas-reservadas-disponiveis-' + campusId).textContent = campusData.vagasReservadasDisponiveis;
    
    // Atualizar vagas ampla
    document.getElementById('vagas-ampla-total-' + campusId).textContent = campusData.numeroVagasAmplaConcorrencia;
    document.getElementById('vagas-ampla-ocupadas-' + campusId).textContent = campusData.vagasAmplaOcupadas;
    document.getElementById('vagas-ampla-disponiveis-' + campusId).textContent = campusData.vagasAmplaDisponiveis;
    
    // Atualizar totais
    document.getElementById('total-vagas-' + campusId).textContent = 
        campusData.numeroVagasReservadas + campusData.numeroVagasAmplaConcorrencia;
    document.getElementById('total-ocupadas-' + campusId).textContent = 
        campusData.vagasReservadasOcupadas + campusData.vagasAmplaOcupadas;
    
    // Atualizar status
    const statusElement = document.getElementById('status-' + campusId);
    const reservadasDisponiveis = campusData.vagasReservadasDisponiveis;
    const amplaDisponiveis = campusData.vagasAmplaDisponiveis;
    
    // Limpar conteúdo anterior
    statusElement.innerHTML = '';
    
    if (reservadasDisponiveis > 0 && amplaDisponiveis > 0) {
        statusElement.innerHTML = '<span class="status-success">Vagas Disponíveis</span>';
    } else if ((reservadasDisponiveis <= 0 && amplaDisponiveis > 0) || (reservadasDisponiveis > 0 && amplaDisponiveis <= 0)) {
        statusElement.innerHTML = '<span class="status-warning">Vagas Limitadas</span>';
    } else {
        statusElement.innerHTML = '<span class="status-danger">Sem Vagas</span>';
    }
}

// Função para excluir campus via AJAX
async function excluirCampus(campusId, campusNome) {
    if (!confirm('Tem certeza que deseja excluir o campus "' + campusNome + '"? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    const row = document.getElementById('campus-row-' + campusId);
    row.classList.add('updating');
    
    try {
        const formData = new URLSearchParams();
        if (_csrf.parameterName && _csrf.token) {
            formData.append(_csrf.parameterName, _csrf.token);
        }
        
        const response = await fetch('/campus/' + campusId + '/excluir-ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remover a linha da tabela
            row.remove();
            showMessage('successMessage', 'Campus excluído com sucesso!');
            
            // Atualizar estatísticas gerais
            updateEstatisticas();
            
            // Verificar se não há mais campus
            const tableBody = document.getElementById('campusTableBody');
            
            // Contar apenas as linhas de dados (que têm a classe 'campus-row')
            const campusRows = tableBody.querySelectorAll('.campus-row');
            
            if (campusRows.length === 0) {
                 // Insere o placeholder usando JavaScript
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center muted">
                            Nenhum campus cadastrado. 
                            <a href="/campus/novo">Cadastre o primeiro campus</a>
                        </td>
                    </tr>
                `;
            }
        } else {
            showMessage('errorMessage', 'Erro ao excluir campus: ' + result.error, true);
            row.classList.remove('updating');
            row.classList.add('error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showMessage('errorMessage', 'Erro de rede ao excluir campus.', true);
        row.classList.remove('updating');
        row.classList.add('error');
    }
}

// Função para atualizar estatísticas gerais (calculando a partir dos dados da tabela)
function updateEstatisticas() {
    let totalReservadas = 0;
    let totalAmpla = 0;
    
    // Seleciona todas as linhas de dados (que têm a classe 'campus-row')
    const rows = document.querySelectorAll('.campus-row');
    
    rows.forEach(row => {
        const campusId = row.id.split('-').pop();
        // Obtém o valor total de vagas reservadas (o Thymeleaf garante que o elemento existe)
        const vagasReservadasTotal = parseInt(document.getElementById('vagas-reservadas-total-' + campusId).textContent) || 0;
        const vagasAmplaTotal = parseInt(document.getElementById('vagas-ampla-total-' + campusId).textContent) || 0;
        
        totalReservadas += vagasReservadasTotal;
        totalAmpla += vagasAmplaTotal;
    });

    const totalGeral = totalReservadas + totalAmpla;
    const totalCampus = rows.length;

    // Atualiza os cartões de estatísticas no topo
    document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = totalCampus;
    document.getElementById('totalReservadas').textContent = totalReservadas;
    document.getElementById('totalAmpla').textContent = totalAmpla;
    document.getElementById('totalGeral').textContent = totalGeral;
    
    console.log('Estatísticas globais atualizadas.');
}

// Inicialização: Adicionar event listeners aos botões
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sistema de campus AJAX carregado');

    // Usando delegação de evento no corpo da tabela para botões dinâmicos
    const tableBody = document.getElementById('campusTableBody');
    if (tableBody) {
        tableBody.addEventListener('click', function(event) {
            
            // Listener para o botão de Atualizar
            if (event.target.classList.contains('btn-atualizar')) {
                const campusId = event.target.getAttribute('data-id');
                // Adiciona um pequeno atraso para garantir que os inputs foram atualizados antes de buscar os valores
                setTimeout(() => atualizarCampus(campusId), 0);
            }
            
            // Listener para o botão de Excluir
            if (event.target.classList.contains('btn-excluir')) {
                const campusId = event.target.getAttribute('data-id');
                const campusNome = event.target.getAttribute('data-nome');
                excluirCampus(campusId, campusNome);
            }
        });
    }

    // Iniciar as estatísticas globais no carregamento
    updateEstatisticas();
});</script>
</body>
</html>
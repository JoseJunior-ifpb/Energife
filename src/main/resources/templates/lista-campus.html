<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Lista de Campus</title>
    <style>
        /* ===== RESET E CONFIGURAÇÕES BÁSICAS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container-app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER E HERO SECTION ===== */
        .hero {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .title h1 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .toolbar {
            display: flex;
            gap: 10px;
        }

        /* ===== BOTÕES ===== */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-ghost {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-ghost:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        /* ===== CARDS ===== */
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* ===== GRID DE ESTATÍSTICAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* ===== TABELA ===== */
        .table-wrap {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        table.styled {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        table.styled thead {
            background-color: #2c3e50;
            color: white;
        }

        table.styled th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        table.styled td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        table.styled tbody tr {
            transition: background-color 0.3s ease;
        }

        table.styled tbody tr:hover {
            background-color: #f8f9fa;
        }

        table.styled tbody tr.updating {
            background-color: #fff9e6;
        }

        table.styled tbody tr.success {
            background-color: #e8f6ef;
        }

        table.styled tbody tr.error {
            background-color: #fdeded;
        }

        /* ===== BADGES DE STATUS ===== */
        .status-badge span {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* ===== FORMULÁRIOS DE EDIÇÃO ===== */
        .edit-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-label {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .number-input {
            width: 90px;
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .number-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Input específico para vagas reservadas */
        .input-reservadas:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Input específico para vagas ampla */
        .input-ampla:focus {
            border-color: #27ae60;
            box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
        }

        /* Input específico para cadastro reserva */
        .input-cadastro-reserva:focus {
            border-color: #e67e22;
            box-shadow: 0 0 0 2px rgba(230, 126, 34, 0.2);
        }

        .saving-indicator {
            color: #3498db;
            font-size: 0.8rem;
            display: none;
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* ===== INFORMAÇÕES SOBRE VAGAS ===== */
        .vaga-info {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .vaga-item {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .vaga-reservada {
            background-color: #e8f4fc;
            border-left-color: #3498db;
        }

        .vaga-ampla {
            background-color: #f0f7f0;
            border-left-color: #27ae60;
        }

        .vaga-item strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .vaga-item div {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        /* ===== MENSAGENS DE FEEDBACK ===== */
        .success-message, .error-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        /* ===== TEXTOS E UTILITÁRIOS ===== */
        .muted {
            color: #7f8c8d;
        }

        .text-center {
            text-align: center;
        }

        strong {
            color: #2c3e50;
        }

        /* ===== ANIMAÇÕES ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: slideIn 0.5s ease;
        }

        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 768px) {
            .hero {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .vaga-info {
                flex-direction: column;
            }
            
            .edit-form {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .input-group {
                width: 100%;
            }
            
            .number-input {
                width: 100%;
            }
            
            table.styled {
                font-size: 0.85rem;
            }
            
            table.styled th, 
            table.styled td {
                padding: 10px 8px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .container-app {
                padding: 10px;
            }
            
            .title h1 {
                font-size: 2rem;
            }
            
            .actions {
                gap: 6px;
            }
        }
    </style>
</head>
<body>
<div class="container-app">
    <div class="hero">
        <div class="title">
            <h1>Lista de Campus</h1>
            <div class="subtitle">Gerencie os campus e suas vagas</div>
        </div>
        <div class="toolbar">
            <a th:href="@{/campus/novo}" class="btn btn-primary">Novo Campus</a>
            <a th:href="@{/candidatos/list}" class="btn btn-ghost">Voltar para Lista</a>
        </div>
    </div>

    <!-- Mensagens dinâmicas -->
    <div id="successMessage" class="success-message"></div>
    <div id="errorMessage" class="error-message"></div>

    <!-- Estatísticas Gerais -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" th:text="${campuses.size()}">0</div>
            <div class="stat-label">Total de Campus</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalReservadas" th:text="${turnos.isEmpty() ? 0 : #aggregates.sum(turnos.![numeroVagasReservadas])}">0</div>
            <div class="stat-label">Vagas Reservadas Totais</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalAmpla" th:text="${turnos.isEmpty() ? 0 : #aggregates.sum(turnos.![numeroVagasAmplaConcorrencia])}">0</div>
            <div class="stat-label">Vagas Ampla Concorrência Totais</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalCadastroReserva" th:text="${turnos.isEmpty() ? 0 : #aggregates.sum(turnos.![numeroVagasCadastroReserva])}">0</div>
            <div class="stat-label">Cadastro de Reserva Totais</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalGeral" th:text="${turnos.isEmpty() ? 0 : #aggregates.sum(turnos.![numeroVagasReservadas + numeroVagasAmplaConcorrencia + numeroVagasClassificado + numeroVagasHabilitado + numeroVagasCadastroReserva])}">0</div>
            <div class="stat-label">Total de Vagas</div>
        </div>
    </div>

    <div class="card">
        <div class="table-wrap">
            <table class="styled">
                <thead>
                <tr>
                    <th>Campus</th>
                    <th>Edital</th>
                    <th>Turno</th>
                    <th>Vagas Reservadas para Mulheres</th>
                    <th>Vagas Ampla Concorrência</th>
                    <th>Vagas Classificado</th>
                    <th>Vagas Habilitado</th>
                    <th>Cadastro de Reserva</th>
                    <th>Total de Vagas</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody id="campusTableBody">
                <tr th:each="turno : ${turnos}" th:id="'turno-row-' + ${turno.campusEditalTurnoId}" class="campus-row">
                    <td>
                        <strong th:text="${turno.campusNome}">Nome do Campus</strong>
                    </td>
                    <td>
                        <span th:text="${turno.editalDescricao}">Descrição Edital</span>
                    </td>
                    <td>
                        <span th:text="${turno.turno}">Turno</span>
                    </td>
                    <td>
                        <div>
                            <span th:id="'vagas-reservadas-ocupadas-' + ${turno.campusEditalTurnoId}" th:text="${turno.vagasReservadasOcupadas}">0</span> / 
                            <span th:id="'vagas-reservadas-total-' + ${turno.campusEditalTurnoId}" th:text="${turno.numeroVagasReservadas}">0</span>
                            <div class="muted" style="font-size: 0.8rem;">
                                <span th:id="'vagas-reservadas-disponiveis-' + ${turno.campusEditalTurnoId}" th:text="${turno.vagasReservadasDisponiveis}">0</span> disponíveis
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <span th:id="'vagas-ampla-ocupadas-' + ${turno.campusEditalTurnoId}" th:text="${turno.vagasAmplaOcupadas}">0</span> / 
                            <span th:id="'vagas-ampla-total-' + ${turno.campusEditalTurnoId}" th:text="${turno.numeroVagasAmplaConcorrencia}">0</span>
                            <div class="muted" style="font-size: 0.8rem;">
                                <span th:id="'vagas-ampla-disponiveis-' + ${turno.campusEditalTurnoId}" th:text="${turno.vagasAmplaDisponiveis}">0</span> disponíveis
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <span th:id="'vagas-classificado-ocupadas-' + ${turno.campusEditalTurnoId}" th:text="${turno.vagasClassificadoOcupadas}">0</span> / 
                            <span th:id="'vagas-classificado-total-' + ${turno.campusEditalTurnoId}" th:text="${turno.numeroVagasClassificado}">0</span>
                            <div class="muted" style="font-size: 0.8rem;">
                                <span th:id="'vagas-classificado-disponiveis-' + ${turno.campusEditalTurnoId}" th:text="${turno.vagasClassificadoDisponiveis}">0</span> disponíveis
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <span th:id="'vagas-habilitado-ocupadas-' + ${turno.campusEditalTurnoId}" th:text="${turno.vagasHabilitadoOcupadas}">0</span> / 
                            <span th:id="'vagas-habilitado-total-' + ${turno.campusEditalTurnoId}" th:text="${turno.numeroVagasHabilitado}">0</span>
                            <div class="muted" style="font-size: 0.8rem;">
                                <span th:id="'vagas-habilitado-disponiveis-' + ${turno.campusEditalTurnoId}" th:text="${turno.vagasHabilitadoDisponiveis}">0</span> disponíveis
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong th:id="'total-vagas-' + ${turno.campusEditalTurnoId}" th:text="${turno.numeroVagasReservadas + turno.numeroVagasAmplaConcorrencia + turno.numeroVagasClassificado + turno.numeroVagasHabilitado + turno.numeroVagasCadastroReserva}">0</strong>
                    </td>
                    <td>
                        <span th:id="'status-' + ${turno.campusEditalTurnoId}" class="status-badge">
                            <span th:if="${turno.vagasReservadasDisponiveis > 0 and turno.vagasAmplaDisponiveis > 0}" 
                                  class="status-success">Vagas Disponíveis</span>
                            <span th:if="${(turno.vagasReservadasDisponiveis <= 0 and turno.vagasAmplaDisponiveis > 0) or (turno.vagasReservadasDisponiveis > 0 and turno.vagasAmplaDisponiveis <= 0)}" 
                                  class="status-warning">Vagas Limitadas</span>
                            <span th:if="${turno.vagasReservadasDisponiveis <= 0 and turno.vagasAmplaDisponiveis <= 0}" 
                                  class="status-danger">Sem Vagas</span>
                        </span>
                    </td>
                    <td>
                        <div class="actions">
                            <!-- Formulário de Edição com AJAX -->
                            <form th:id="'edit-form-' + ${turno.campusEditalTurnoId}" class="edit-form">
                                <div class="input-group">
                                    <label class="input-label">Reservadas</label>
                                    <input type="number" 
                                           th:id="'input-reservadas-' + ${turno.campusEditalTurnoId}"
                                           th:value="${turno.numeroVagasReservadas}" 
                                           class="number-input input-reservadas" 
                                           min="0" 
                                           required />
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Ampla Concorrência</label>
                                    <input type="number" 
                                           th:id="'input-ampla-' + ${turno.campusEditalTurnoId}"
                                           th:value="${turno.numeroVagasAmplaConcorrencia}" 
                                           class="number-input input-ampla" 
                                           min="0" 
                                           required />
                                </div>
                            <div class="input-group">
                                <label class="input-label">Classificado</label>
                                <input type="number"
                                       th:id="'input-classificado-' + ${turno.campusEditalTurnoId}"
                                       th:value="${turno.numeroVagasClassificado}"
                                       class="number-input input-classificado"
                                       min="0"
                                       required />
                            </div>
                            <div class="input-group">
                                <label class="input-label">Habilitado</label>
                                <input type="number"
                                       th:id="'input-habilitado-' + ${turno.campusEditalTurnoId}"
                                       th:value="${turno.numeroVagasHabilitado}"
                                       class="number-input input-habilitado"
                                       min="0"
                                       required />
                            </div>
                            <div class="input-group">
                                <label class="input-label">Cadastro Reserva</label>
                                <input type="number" 
                                       th:id="'input-cadastro-reserva-' + ${turno.campusEditalTurnoId}"
                                       th:value="${turno.numeroVagasCadastroReserva}" 
                                       class="number-input input-cadastro-reserva" 
                                       min="0" 
                                       required />
                            </div>
                                <button type="button" 
                                        th:data-id="${turno.campusEditalTurnoId}"
                                        class="btn btn-sm btn-primary btn-atualizar">
                                    Atualizar
                                </button>
                                <span th:id="'saving-' + ${turno.campusEditalTurnoId}" class="saving-indicator">Salvando...</span>
                            </form>
                            
                            <!-- Botão Excluir com AJAX -->
                            <button type="button" 
                                    th:data-id="${turno.campusEditalTurnoId}"
                                    th:data-nome="${turno.campusNome + ' (' + turno.turno + ')'}"
                                    class="btn btn-sm btn-danger btn-excluir">
                                Excluir
                            </button>
                        </div>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(turnos)}">
                    <td colspan="11" class="text-center muted">
                        Nenhum campus cadastrado. 
                        <a th:href="@{/campus/novo}">Cadastre o primeiro campus</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Informações -->
    <div class="card" style="margin-top: 20px;">
        <h3>Informações sobre as Vagas</h3>
        <div class="vaga-info">
            <div class="vaga-item vaga-reservada">
                <strong>Vagas Reservadas</strong>
                <div>Destinadas a candidatas do sexo feminino</div>
            </div>
            <div class="vaga-item vaga-ampla">
                <strong>Vagas Ampla Concorrência</strong>
                <div>Destinadas a candidatos do sexo masculino</div>
            </div>
        </div>
        <div style="margin-top: 16px;">
            <p><strong>Nota:</strong> O sistema determina automaticamente o tipo de vaga baseado no gênero do candidato.</p>
            <ul>
                <li><strong>Feminino</strong> → Concorre às <strong>Vagas Reservadas</strong></li>
                <li><strong>Masculino</strong> → Concorre às <strong>Vagas Ampla Concorrência</strong></li>
            </ul>
        </div>
    </div>
</div>

<script>
// CSRF Token (se disponível)
const _csrf = {
    parameterName: /*[[${_csrf?.parameterName}]]*/ '_csrf',
    token: /*[[${_csrf?.token}]]*/ ''
};

// Função para mostrar mensagem
function showMessage(elementId, message, isError = false) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.style.display = 'block';
    
    if (isError) {
        element.className = 'error-message';
    } else {
        element.className = 'success-message';
    }
    
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}

// Função para atualizar campus via AJAX
async function atualizarCampus(campusId) {
    console.log('Iniciando atualização do turno/campus ID:', campusId);
    
    const reservadasInput = document.getElementById('input-reservadas-' + campusId);
    const amplaInput = document.getElementById('input-ampla-' + campusId);
    const cadastroReservaInput = document.getElementById('input-cadastro-reserva-' + campusId);
    const savingIndicator = document.getElementById('saving-' + campusId);
    const row = document.getElementById('turno-row-' + campusId); // Nota: corrigido para 'turno-row-'
    
    const numeroVagasReservadas = parseInt(reservadasInput.value) || 0;
    const numeroVagasAmplaConcorrencia = parseInt(amplaInput.value) || 0;
    const numeroVagasClassificado = (() => { const el = document.getElementById('input-classificado-' + campusId); return el ? (parseInt(el.value) || 0) : 0; })();
    const numeroVagasHabilitado = (() => { const el = document.getElementById('input-habilitado-' + campusId); return el ? (parseInt(el.value) || 0) : 0; })();
    const numeroVagasCadastroReserva = parseInt(cadastroReservaInput.value) || 0;
    
    // Validação
    if (numeroVagasReservadas < 0 || numeroVagasAmplaConcorrencia < 0 || numeroVagasCadastroReserva < 0) {
        showMessage('errorMessage', 'O número de vagas não pode ser negativo.', true);
        return;
    }
    
    if (numeroVagasReservadas === 0 && numeroVagasAmplaConcorrencia === 0 && numeroVagasClassificado === 0 && numeroVagasHabilitado === 0 && numeroVagasCadastroReserva === 0) {
        if (!confirm('Todos os tipos de vaga estão com 0 vagas. Tem certeza que deseja continuar?')) {
            return;
        }
    }
    
    // Mostrar indicador de salvamento
    savingIndicator.style.display = 'inline';
    if (row) {
        row.classList.add('updating');
    }
    
    try {
        const formData = new URLSearchParams();
        formData.append('numeroVagasReservadas', numeroVagasReservadas);
        formData.append('numeroVagasAmplaConcorrencia', numeroVagasAmplaConcorrencia);
        formData.append('numeroVagasClassificado', numeroVagasClassificado);
        formData.append('numeroVagasHabilitado', numeroVagasHabilitado);
        formData.append('numeroVagasCadastroReserva', numeroVagasCadastroReserva);
        if (_csrf.parameterName && _csrf.token) {
            formData.append(_csrf.parameterName, _csrf.token);
        }
        
        const url = '/campus/' + campusId + '/editar-ajax';
        console.log('Enviando POST para:', url, 'com dados:', Object.fromEntries(formData));
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData
        });
        
        console.log('Resposta recebida. Status:', response.status, 'Content-Type:', response.headers.get('Content-Type'));
        
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        
        const result = await response.json();
        console.log('JSON parseado:', result);
        
        if (result.success) {
            console.log('Sucesso! Atualizando linha...');
            // Atualizar a linha com os novos dados
            updateCampusRow(campusId, result.campus);
            if (row) {
                row.classList.remove('updating');
                row.classList.add('success');
            }
            showMessage('successMessage', 'Campus atualizado com sucesso!');
            
            // Atualizar estatísticas gerais
            updateEstatisticas();
            
            // Remover classe de sucesso após 2 segundos
            setTimeout(() => {
                if (row) {
                    row.classList.remove('success');
                }
            }, 2000);
        } else {
            console.error('Falha na resposta:', result.error);
            showMessage('errorMessage', 'Erro ao atualizar campus: ' + (result.error || 'Erro desconhecido'), true);
            if (row) {
                row.classList.remove('updating');
                row.classList.add('error');
            }
        }
    } catch (error) {
        console.error('Erro ao atualizar:', error);
        showMessage('errorMessage', 'Erro de rede ao atualizar campus: ' + error.message, true);
        if (row) {
            row.classList.remove('updating');
            row.classList.add('error');
        }
    } finally {
        console.log('Finalizando atualização. Ocultando indicador de salvamento...');
        savingIndicator.style.display = 'none';
    }
}

// Função para atualizar os dados da linha
function updateCampusRow(campusId, campusData) {
    // Atualizar vagas reservadas
    document.getElementById('vagas-reservadas-total-' + campusId).textContent = campusData.numeroVagasReservadas;
    document.getElementById('vagas-reservadas-ocupadas-' + campusId).textContent = campusData.vagasReservadasOcupadas;
    document.getElementById('vagas-reservadas-disponiveis-' + campusId).textContent = campusData.vagasReservadasDisponiveis;
    
    // Atualizar vagas ampla
    document.getElementById('vagas-ampla-total-' + campusId).textContent = campusData.numeroVagasAmplaConcorrencia;
    document.getElementById('vagas-ampla-ocupadas-' + campusId).textContent = campusData.vagasAmplaOcupadas;
    document.getElementById('vagas-ampla-disponiveis-' + campusId).textContent = campusData.vagasAmplaDisponiveis;
    
    // Atualizar vagas classificado/habilitado
    const classificadoTotalEl = document.getElementById('vagas-classificado-total-' + campusId);
    if (classificadoTotalEl && campusData.numeroVagasClassificado !== undefined) {
        classificadoTotalEl.textContent = campusData.numeroVagasClassificado;
    }
    const classificadoOcupadasEl = document.getElementById('vagas-classificado-ocupadas-' + campusId);
    if (classificadoOcupadasEl && campusData.vagasClassificadoOcupadas !== undefined) {
        classificadoOcupadasEl.textContent = campusData.vagasClassificadoOcupadas;
    }
    const classificadoDispEl = document.getElementById('vagas-classificado-disponiveis-' + campusId);
    if (classificadoDispEl && campusData.vagasClassificadoDisponiveis !== undefined) {
        classificadoDispEl.textContent = campusData.vagasClassificadoDisponiveis;
    }

    const habilitadoTotalEl = document.getElementById('vagas-habilitado-total-' + campusId);
    if (habilitadoTotalEl && campusData.numeroVagasHabilitado !== undefined) {
        habilitadoTotalEl.textContent = campusData.numeroVagasHabilitado;
    }
    const habilitadoOcupEl = document.getElementById('vagas-habilitado-ocupadas-' + campusId);
    if (habilitadoOcupEl && campusData.vagasHabilitadoOcupadas !== undefined) {
        habilitadoOcupEl.textContent = campusData.vagasHabilitadoOcupadas;
    }
    const habilitadoDispEl = document.getElementById('vagas-habilitado-disponiveis-' + campusId);
    if (habilitadoDispEl && campusData.vagasHabilitadoDisponiveis !== undefined) {
        habilitadoDispEl.textContent = campusData.vagasHabilitadoDisponiveis;
    }

    // Atualizar vagas cadastro reserva (se existir)
    const vagasCadastroTotal = document.getElementById('vagas-cadastro-total-' + campusId);
    if (vagasCadastroTotal && campusData.numeroVagasCadastroReserva !== undefined) {
        vagasCadastroTotal.textContent = campusData.numeroVagasCadastroReserva;
    }
    
    // Atualizar totais
    const totalVagasEl = document.getElementById('total-vagas-' + campusId);
    if (totalVagasEl) {
        totalVagasEl.textContent = (campusData.numeroVagasReservadas || 0) + (campusData.numeroVagasAmplaConcorrencia || 0) + (campusData.numeroVagasClassificado || 0) + (campusData.numeroVagasHabilitado || 0) + (campusData.numeroVagasCadastroReserva || 0);
    }
    const totalOcupadasEl = document.getElementById('total-ocupadas-' + campusId);
    if (totalOcupadasEl) {
        totalOcupadasEl.textContent = (campusData.vagasReservadasOcupadas || 0) + (campusData.vagasAmplaOcupadas || 0) + (campusData.vagasClassificadoOcupadas || 0) + (campusData.vagasHabilitadoOcupadas || 0);
    }
    
    // Atualizar status
    const statusElement = document.getElementById('status-' + campusId);
    const reservadasDisponiveis = campusData.vagasReservadasDisponiveis;
    const amplaDisponiveis = campusData.vagasAmplaDisponiveis;
    
    // Limpar conteúdo anterior
    statusElement.innerHTML = '';
    
    if (reservadasDisponiveis > 0 && amplaDisponiveis > 0) {
        statusElement.innerHTML = '<span class="status-success">Vagas Disponíveis</span>';
    } else if ((reservadasDisponiveis <= 0 && amplaDisponiveis > 0) || (reservadasDisponiveis > 0 && amplaDisponiveis <= 0)) {
        statusElement.innerHTML = '<span class="status-warning">Vagas Limitadas</span>';
    } else {
        statusElement.innerHTML = '<span class="status-danger">Sem Vagas</span>';
    }
}

// Função para excluir campus via AJAX
async function excluirCampus(campusId, campusNome) {
    if (!confirm('Tem certeza que deseja excluir o campus "' + campusNome + '"? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    const row = document.getElementById('turno-row-' + campusId); // Nota: corrigido para 'turno-row-'
    if (row) {
        row.classList.add('updating');
    }
    
    try {
        const formData = new URLSearchParams();
        if (_csrf.parameterName && _csrf.token) {
            formData.append(_csrf.parameterName, _csrf.token);
        }
        
        const response = await fetch('/campus/' + campusId + '/excluir-ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remover a linha da tabela
            if (row) {
                row.remove();
            }
            showMessage('successMessage', 'Campus excluído com sucesso!');
            
            // Atualizar estatísticas gerais
            updateEstatisticas();
            
            // Verificar se não há mais campus
            const tableBody = document.getElementById('campusTableBody');
            const campusRows = tableBody.querySelectorAll('.campus-row');
            
            if (campusRows.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center muted">
                            Nenhum campus cadastrado. 
                            <a href="/campus/novo">Cadastre o primeiro campus</a>
                        </td>
                    </tr>
                `;
            }
        } else {
            showMessage('errorMessage', 'Erro ao excluir campus: ' + result.error, true);
            if (row) {
                row.classList.remove('updating');
                row.classList.add('error');
            }
        }
    } catch (error) {
        console.error('Erro:', error);
        showMessage('errorMessage', 'Erro de rede ao excluir campus.', true);
        if (row) {
            row.classList.remove('updating');
            row.classList.add('error');
        }
    }
}

// Função para atualizar estatísticas gerais
function updateEstatisticas() {
    let totalReservadas = 0;
    let totalAmpla = 0;
    let totalCadastroReserva = 0;
    let totalClassificado = 0;
    let totalHabilitado = 0;
    
    const rows = document.querySelectorAll('.campus-row');
    
    rows.forEach(row => {
        const campusId = row.id.split('-').pop();
        const vagasReservadasTotal = parseInt(document.getElementById('vagas-reservadas-total-' + campusId).textContent) || 0;
        const vagasAmplaTotal = parseInt(document.getElementById('vagas-ampla-total-' + campusId).textContent) || 0;
        const vagasCadastroReservaTotal = (document.getElementById('vagas-cadastro-total-' + campusId) ? parseInt(document.getElementById('vagas-cadastro-total-' + campusId).textContent) || 0 : 0);
        const vagasClassificadoTotal = (document.getElementById('vagas-classificado-total-' + campusId) ? parseInt(document.getElementById('vagas-classificado-total-' + campusId).textContent) || 0 : 0);
        const vagasHabilitadoTotal = (document.getElementById('vagas-habilitado-total-' + campusId) ? parseInt(document.getElementById('vagas-habilitado-total-' + campusId).textContent) || 0 : 0);
        
        totalReservadas += vagasReservadasTotal;
        totalAmpla += vagasAmplaTotal;
        totalCadastroReserva += vagasCadastroReservaTotal;
        totalClassificado += vagasClassificadoTotal;
        totalHabilitado += vagasHabilitadoTotal;
    });

    const totalGeral = totalReservadas + totalAmpla + totalClassificado + totalHabilitado + totalCadastroReserva;
    const totalCampus = rows.length;

    // Atualiza os cartões de estatísticas
    document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = totalCampus;
    document.getElementById('totalReservadas').textContent = totalReservadas;
    document.getElementById('totalAmpla').textContent = totalAmpla;
    document.getElementById('totalCadastroReserva').textContent = totalCadastroReserva;
    document.getElementById('totalGeral').textContent = totalGeral;
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sistema de campus AJAX carregado');

    const tableBody = document.getElementById('campusTableBody');
    if (tableBody) {
        tableBody.addEventListener('click', function(event) {
            const btnAtualizar = event.target.closest('.btn-atualizar');
            const btnExcluir = event.target.closest('.btn-excluir');
            
            if (btnAtualizar) {
                const campusId = btnAtualizar.getAttribute('data-id');
                setTimeout(() => atualizarCampus(campusId), 0);
            }
            
            if (btnExcluir) {
                const campusId = btnExcluir.getAttribute('data-id');
                const campusNome = btnExcluir.getAttribute('data-nome');
                excluirCampus(campusId, campusNome);
            }
        });
    }

    updateEstatisticas();
});
</script>
</body>
</html>